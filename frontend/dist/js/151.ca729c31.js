"use strict";(self["webpackChunkwebserver"]=self["webpackChunkwebserver"]||[]).push([[151],{9151:function(e,s,t){t.r(s),t.d(s,{default:function(){return Ke}});var i=t(6768),a=t(5130),o=t(4232);const r=e=>((0,i.Qi)("data-v-d11d08d8"),e=e(),(0,i.jt)(),e),n={class:"container-chat"},l={class:"chat_sidebar"},d={class:"search"},c=["onClick"],m={key:0,class:"recieve_message"},h=["onClick"],u={key:0,class:"recieve_message"},g={class:"chat_content"},p={class:"header"},k={class:"selected_room"},f={key:0,class:"error"},_={class:"header_right"},v={class:"user"},b={class:"message_container"},L=["id"],w={key:0,class:"error"},C={class:"msg_name"},E={key:1,class:"text"},y=["src","onClick"],I={class:"chat_footer"},M={class:"image_preview"},U={class:"image"},S=r((()=>(0,i.Lk)("i",{class:"icon i_close"},null,-1))),x=[S],R=["src"],N={class:"image_options"},j=r((()=>(0,i.Lk)("p",null,"Сжать изображение",-1))),D={class:"text_field"},P=r((()=>(0,i.Lk)("label",{for:"add_pic"},[(0,i.Lk)("i",{class:"i_add_pic icon","data-title":"Add picture"})],-1)));function A(e,s,t,r,S,A){const F=(0,i.g2)("EditUser"),T=(0,i.g2)("ChangePass"),X=(0,i.g2)("EmojiPicker"),O=(0,i.g2)("ImagePreview");return(0,i.uX)(),(0,i.CE)(i.FK,null,[S.isShowEditUser?((0,i.uX)(),(0,i.Wv)(F,{key:0,onCloseEdit:A.closeEditUser,onChangePass:A.showChangePass,user:e.user},null,8,["onCloseEdit","onChangePass","user"])):(0,i.Q3)("",!0),S.isShowChangePass?((0,i.uX)(),(0,i.Wv)(T,{key:1,onClose:A.closeChangePass,user_id:e.user.id},null,8,["onClose","user_id"])):(0,i.Q3)("",!0),(0,i.bF)(a.eB,{name:"picker"},{default:(0,i.k6)((()=>[S.isEmoji?((0,i.uX)(),(0,i.Wv)(X,{key:0,onSet_emoji:A.set_emoji,onClose:A.closeEmoji},null,8,["onSet_emoji","onClose"])):(0,i.Q3)("",!0)])),_:1}),S.isShowImagePreview?((0,i.uX)(),(0,i.Wv)(O,{key:2,onClose:A.closePopUpImage,img:S.popUpImgSrc},null,8,["onClose","img"])):(0,i.Q3)("",!0),(0,i.Lk)("div",n,[(0,i.Lk)("div",l,[(0,i.Lk)("div",d,[(0,i.bo)((0,i.Lk)("input",{type:"search","onUpdate:modelValue":s[0]||(s[0]=e=>S.filter_name=e),id:"search",placeholder:"Поиск...",autocomplete:"off"},null,512),[[a.Jo,S.filter_name]])]),(0,i.Lk)("ul",null,[((0,i.uX)(!0),(0,i.CE)(i.FK,null,(0,i.pI)(S.roomsList,(e=>((0,i.uX)(),(0,i.CE)("li",{key:e.id,onClick:s=>A.roomClick(e),class:(0,o.C4)(["room",{selected:A.roomSelected(e.id)}])},[(0,i.eW)((0,o.v_)(e.name)+" ",1),e.isActiveMessage?((0,i.uX)(),(0,i.CE)("span",m,(0,o.v_)(e.numOfMessages),1)):(0,i.Q3)("",!0)],10,c)))),128))]),(0,i.Lk)("ul",null,[((0,i.uX)(!0),(0,i.CE)(i.FK,null,(0,i.pI)(A.filteredList,(e=>((0,i.uX)(),(0,i.CE)("li",{key:e.id,onClick:s=>A.userListClick(e),class:(0,o.C4)({selected:A.roomSelected(e.id)})},[(0,i.Lk)("p",{class:(0,o.C4)({online:e.online})},[(0,i.eW)((0,o.v_)(e.name)+" ",1),(0,i.Lk)("i",{class:(0,o.C4)(["status",{status_online:e.online}])},null,2)],2),e.isActiveMessage?((0,i.uX)(),(0,i.CE)("span",u,(0,o.v_)(e.numOfMessages),1)):(0,i.Q3)("",!0)],10,h)))),128))])]),(0,i.Lk)("section",g,[(0,i.Lk)("div",p,[(0,i.Lk)("div",k,[(0,i.Lk)("h1",null,(0,o.v_)(S.selected_room.name),1),(0,i.bo)((0,i.Lk)("i",{class:(0,o.C4)(["icon",{i_online:S.selected_room.online,i_offline:!S.selected_room.online}])},null,2),[[a.aG,!S.isRoom]])]),(0,i.Lk)("h2",null,[S.connection_error?((0,i.uX)(),(0,i.CE)("span",f,"network connection error")):(0,i.Q3)("",!0)]),(0,i.Lk)("div",_,[(0,i.Lk)("p",v,(0,o.v_)(A.setUserName()),1),(0,i.Lk)("button",{onClick:s[1]||(s[1]=(...e)=>A.showEditUser&&A.showEditUser(...e)),class:"i_properties icon"}),(0,i.Lk)("button",{onClick:s[2]||(s[2]=(...e)=>A.logout&&A.logout(...e)),class:"i_logout icon"})])]),(0,i.Lk)("div",b,[(0,i.Lk)("div",{class:"messages",id:"messages",onClick:s[3]||(s[3]=e=>A.messageSpaceClick())},[((0,i.uX)(!0),(0,i.CE)(i.FK,null,(0,i.pI)(S.rooms[A.indexOfSelectedRoom].messages,((e,s)=>((0,i.uX)(),(0,i.CE)("div",{key:"m-"+s,class:"message",id:s+1},[(0,i.Lk)("div",{class:(0,o.C4)({send:"me"==e.from,response:"other"==e.from})},[(0,i.Lk)("ul",null,[1==e.err?((0,i.uX)(),(0,i.CE)("li",w,"Ошибка отправки сообщения")):(0,i.Q3)("",!0),(0,i.Lk)("li",C,(0,o.v_)(e.name),1),"text"==e.type?((0,i.uX)(),(0,i.CE)("li",E,(0,o.v_)(e.message),1)):(0,i.Q3)("",!0),"image"==e.type?((0,i.uX)(),(0,i.CE)("img",{key:2,src:e.message,onClick:s=>A.popUpImage(e.message)},null,8,y)):(0,i.Q3)("",!0)])],2)],8,L)))),128))])]),(0,i.Lk)("div",I,[(0,i.bo)((0,i.Lk)("div",M,[(0,i.Lk)("div",U,[(0,i.Lk)("div",{class:"close_preview",onClick:s[4]||(s[4]=(...e)=>A.closePreview&&A.closePreview(...e))},x),(0,i.Lk)("img",{src:S.imageSrc},null,8,R)]),(0,i.Lk)("div",N,[(0,i.bo)((0,i.Lk)("input",{type:"checkbox",name:"compress image",id:"","onUpdate:modelValue":s[5]||(s[5]=e=>S.isCompressImage=e)},null,512),[[a.lH,S.isCompressImage]]),j])],512),[[a.aG,S.isImage]]),(0,i.Lk)("div",D,[(0,i.bo)((0,i.Lk)("input",{"onUpdate:modelValue":s[6]||(s[6]=e=>S.text=e),type:"text",id:"add_text",placeholder:"Сообщение...",onKeyup:s[7]||(s[7]=(0,a.jR)(((...e)=>A.send_message&&A.send_message(...e)),["enter"]))},null,544),[[a.Jo,S.text]]),(0,i.Lk)("i",{class:"i_emoji icon",onMouseenter:s[8]||(s[8]=(...e)=>A.showEmoji&&A.showEmoji(...e)),onMouseleave:s[9]||(s[9]=(...e)=>A.closeEmoji&&A.closeEmoji(...e))},null,32),(0,i.Lk)("input",{type:"file",accept:"image/*",id:"add_pic","on:change":s[10]||(s[10]=(...e)=>A.loadImage&&A.loadImage(...e)),ref:"imgUpload"},null,544),P,A.showSendBtn()?((0,i.uX)(),(0,i.CE)("i",{key:0,class:"i_send icon",onClick:s[11]||(s[11]=(...e)=>A.send_message&&A.send_message(...e)),"data-title":"Send message"})):(0,i.Q3)("",!0)])])])])],64)}t(4114),t(6573),t(8100),t(7936),t(7467),t(4732),t(9577),t(4979);const F=e=>((0,i.Qi)("data-v-fc240de6"),e=e(),(0,i.jt)(),e),T={class:"popup_wrapper",ref:"popup_wrapper"},X={class:"edit_popup"},O={key:0,class:"reuslt_ok"},Q={key:1,class:"result_err"},$={class:"blok"},B=F((()=>(0,i.Lk)("label",{for:"name"},"Имя:",-1))),V={class:"blok"},J=F((()=>(0,i.Lk)("label",{for:"familyname"},"Фамилия:",-1))),q={class:"blok"},K=F((()=>(0,i.Lk)("label",{for:"surname"},"Отчество:",-1))),W={class:"blok"},H=F((()=>(0,i.Lk)("label",{for:"birthdate"},"Дата Рождения:",-1))),G={class:"change_pass"},Y={class:"edit_footer"};function z(e,s,t,r,n,l){return(0,i.uX)(),(0,i.CE)("div",T,[(0,i.Lk)("div",X,[(0,i.Lk)("div",null,[n.resultOk?((0,i.uX)(),(0,i.CE)("p",O,"Данные успешно обновлены")):(0,i.Q3)("",!0),n.resultErr?((0,i.uX)(),(0,i.CE)("p",Q,(0,o.v_)(n.errString),1)):(0,i.Q3)("",!0)]),(0,i.Lk)("div",$,[B,(0,i.bo)((0,i.Lk)("input",{type:"text",id:"name","onUpdate:modelValue":s[0]||(s[0]=e=>n.name=e)},null,512),[[a.Jo,n.name]])]),(0,i.Lk)("div",V,[J,(0,i.bo)((0,i.Lk)("input",{type:"text",id:"familyname","onUpdate:modelValue":s[1]||(s[1]=e=>n.familyname=e)},null,512),[[a.Jo,n.familyname]])]),(0,i.Lk)("div",q,[K,(0,i.bo)((0,i.Lk)("input",{type:"text",id:"surname","onUpdate:modelValue":s[2]||(s[2]=e=>n.surname=e)},null,512),[[a.Jo,n.surname]])]),(0,i.Lk)("div",W,[H,(0,i.bo)((0,i.Lk)("input",{type:"date",id:"birthdate","onUpdate:modelValue":s[3]||(s[3]=e=>n.birthdate=e)},null,512),[[a.Jo,n.birthdate]])]),(0,i.Lk)("div",G,[(0,i.Lk)("button",{onClick:s[4]||(s[4]=(...e)=>l.changePass&&l.changePass(...e))},"Сменить пароль")]),(0,i.Lk)("div",Y,[(0,i.Lk)("button",{class:"save",onClick:s[5]||(s[5]=(...e)=>l.updateUserInfo&&l.updateUserInfo(...e))},"Сохранить"),(0,i.Lk)("button",{class:"close",onClick:s[6]||(s[6]=(...e)=>l.closeEdit&&l.closeEdit(...e))},"Закрыть")])])],512)}var Z=t(7416),ee={props:{id:{type:Number,default:0}},data(){return{name:"",familyname:"",surname:"",birthdate:"",resultOk:!1,resultErr:!1,errString:""}},mounted(){let e=this;document.addEventListener("click",(function(s){s.target==e.$refs["popup_wrapper"]&&e.closeEdit()}))},methods:{closeEdit(){this.$emit("closeEdit")},changePass(){this.$emit("changePass")},updateUserInfo(){let e={id:this.id,name:this.name,familyname:this.familyname,surname:this.surname,birthdate:this.birthdate};(0,Z.bE)("/userupdate",e).then((()=>{this.resultOk=!0})).catch((e=>{this.resultErr=!0,this.errString="Ошибка: "+e}))}}},se=t(1241);const te=(0,se.A)(ee,[["render",z],["__scopeId","data-v-fc240de6"]]);var ie=te;const ae=e=>((0,i.Qi)("data-v-5c56cc72"),e=e(),(0,i.jt)(),e),oe={class:"popup_wrapper",ref:"popup_wrapper"},re={class:"change_popup"},ne={class:"close"},le=ae((()=>(0,i.Lk)("h1",null,"Сменить пароль",-1))),de={class:"error"},ce=ae((()=>(0,i.Lk)("p",null,"Пороль обновлён",-1))),me=[ce],he={class:"input"},ue=["type"],ge={class:"input"},pe=["type"],ke={key:0,class:"input"},fe=["type"],_e={class:"check_block"},ve={class:"check"},be=ae((()=>(0,i.Lk)("label",{for:"show_pass"},"Показать пароль",-1))),Le={class:"button_block"},we=["disabled"];function Ce(e,s,t,r,n,l){return(0,i.uX)(),(0,i.CE)("div",oe,[(0,i.Lk)("div",re,[(0,i.Lk)("form",{onSubmit:s[5]||(s[5]=(0,a.D$)(((...e)=>l.changePass&&l.changePass(...e)),["prevent"]))},[(0,i.Lk)("div",ne,[(0,i.Lk)("p",{onClick:s[0]||(s[0]=(...e)=>l.close&&l.close(...e)),title:"Закрыть"},"X")]),le,(0,i.bo)((0,i.Lk)("div",de,[(0,i.Lk)("p",null,"Error: "+(0,o.v_)(n.errResult),1)],512),[[a.aG,n.isEroor]]),(0,i.bo)((0,i.Lk)("div",null,me,512),[[a.aG,n.isResult]]),(0,i.Lk)("div",he,[(0,i.bo)((0,i.Lk)("input",{required:"",type:n.show_pass?"text":"password",placeholder:"текущий пароль","onUpdate:modelValue":s[1]||(s[1]=e=>n.old_password=e)},null,8,ue),[[a.hp,n.old_password]])]),(0,i.Lk)("div",ge,[(0,i.bo)((0,i.Lk)("input",{required:"",type:n.show_pass?"text":"password",placeholder:"новый пароль","onUpdate:modelValue":s[2]||(s[2]=e=>n.new_password=e)},null,8,pe),[[a.hp,n.new_password]])]),l.confirm?((0,i.uX)(),(0,i.CE)("div",ke,[(0,i.bo)((0,i.Lk)("input",{required:"",type:n.show_pass?"text":"password",placeholder:"подтвердите пароль","onUpdate:modelValue":s[3]||(s[3]=e=>n.confirmed_password=e)},null,8,fe),[[a.hp,n.confirmed_password]])])):(0,i.Q3)("",!0),(0,i.Lk)("div",_e,[(0,i.Lk)("div",ve,[(0,i.bo)((0,i.Lk)("input",{type:"checkbox",id:"show_pass","onUpdate:modelValue":s[4]||(s[4]=e=>n.show_pass=e)},null,512),[[a.lH,n.show_pass]]),be])]),(0,i.Lk)("div",Le,[(0,i.Lk)("button",{type:"submit",disabled:!l.check_pass,class:(0,o.C4)(l.check_pass?"activ":"non_activ")},"Подтвердить",10,we)])],32)])],512)}var Ee={props:{user_id:Number,server_addr:{type:String,default:"localhos:8080"}},data(){return{old_password:"",new_password:"",confirmed_password:"",show_pass:!1,isResult:!1,isEroor:!1,errResult:""}},mounted(){let e=this;document.addEventListener("click",(function(s){s.target==e.$refs["popup_wrapper"]&&e.close()}))},methods:{changePass(){let e={id:this.user_id,old:this.old_password,new:this.new_password};(0,Z.bE)("/changepass",e).then((()=>{this.isResult=!0,this.isEroor=!1})).catch((e=>{this.isResult=!1,this.isEroor=!0,this.errResult=e.response.data}))},close(){this.$emit("close")}},computed:{confirm(){return this.new_password.length>4},check_pass(){return!(this.new_password.length<4)&&this.new_password==this.confirmed_password}}};const ye=(0,se.A)(Ee,[["render",Ce],["__scopeId","data-v-5c56cc72"]]);var Ie=ye;const Me=e=>((0,i.Qi)("data-v-55979468"),e=e(),(0,i.jt)(),e),Ue={class:"popup_wrapper",ref:"popup_wrapper"},Se={class:"img_preview"},xe=Me((()=>(0,i.Lk)("i",{class:"icon i_close"},null,-1))),Re=[xe],Ne=["src"];function je(e,s,t,a,o,r){return(0,i.uX)(),(0,i.CE)("div",Ue,[(0,i.Lk)("div",Se,[(0,i.Lk)("div",{onClick:s[0]||(s[0]=(...e)=>r.close&&r.close(...e))},Re),(0,i.Lk)("img",{src:t.img},null,8,Ne)])],512)}var De={props:{img:{type:String,default:""}},mounted(){let e=this;document.addEventListener("click",(function(s){s.target==e.$refs["popup_wrapper"]&&e.close()}))},methods:{close(){this.$emit("close")}}};const Pe=(0,se.A)(De,[["render",je],["__scopeId","data-v-55979468"]]);var Ae=Pe;const Fe={class:"emojis_conteiner"},Te={class:"emoji"},Xe=["title","onClick"];function Oe(e,s,t,a,r,n){return(0,i.uX)(),(0,i.CE)("div",{class:"emoji_picker",onMouseleave:s[0]||(s[0]=(...e)=>n.close&&n.close(...e))},[(0,i.Lk)("div",Fe,[((0,i.uX)(!0),(0,i.CE)(i.FK,null,(0,i.pI)(this.emojis,((e,s)=>((0,i.uX)(),(0,i.CE)("div",{key:s},[(0,i.Lk)("h5",null,(0,o.v_)(s),1),(0,i.Lk)("div",Te,[((0,i.uX)(!0),(0,i.CE)(i.FK,null,(0,i.pI)(e,((e,s)=>((0,i.uX)(),(0,i.CE)("span",{key:s,title:s,onClick:s=>n.set_emoji(e)},(0,o.v_)(e),9,Xe)))),128))])])))),128))])],32)}var Qe={data(){return{emojis:{"face-smiling":{"grinning face":"😀","grinning face with big eyes":"😃","grinning face with smiling eyes":"😄","beaming face with smiling eyes":"😁"},"face-affection":{"smiling face with hearts":"🥰","smiling face with heart-eyes":"😍","star-struck":"🤩","face blowing a kiss":"😘"}},emoji:""}},methods:{set_emoji(e){this.emoji=e,this.$emit("set_emoji",{value:this.emoji})},close(){this.$emit("close")}}};const $e=(0,se.A)(Qe,[["render",Oe]]);var Be=$e,Ve=t(4652),Je={components:{EditUser:ie,ChangePass:Ie,ImagePreview:Ae,EmojiPicker:Be},data(){return{id:0,user_name:"",isShowEditUser:!1,isShowChangePass:!1,isEmoji:!1,isShowImagePreview:!1,isImage:!1,isCompressImage:!0,imageSrc:"",popUpImgSrc:"",roomsList:[{id:0,name:"Общие",isActiveMessage:!1,numOfActiveMessages:0}],list:[{id:0,name:"",online:!1,isActiveMessage:!1,numOfActiveMessages:0}],filter_name:"",isRoom:!0,selected_room:{id:0,name:"Общие",online:!1,lastLoadedNumber:0},rooms:[{id:0,lastLoadedNumber:0,messages:[]}],connection_ready:!1,connection_error:!0,websocket:null,control:Ve.T.ControlCommand,data:Ve.T.Data,assembler:Ve.T.assembler,text:"",messages:[],selectRoomMessages:[],observerOptions:{root:null,rootMargin:"0px",threshold:.1}}},mounted(){this.init_chat()},methods:{init_chat(){(0,Z.Jt)("/chat").then((e=>{this.id=e.data.user,parseInt(localStorage.getItem("id"))!=this.id&&(localStorage.clear(),localStorage.setItem("id",this.id)),null==localStorage.getItem("name")?this.ask_name(this.id):this.user_name=localStorage.getItem("name"),this.init_ws_chat(this.id)})).catch((e=>{if("Network Error"!=e.message)return 401==e.response.status&&this.$router.push("/login"),"false"}))},ask_name(e){(0,Z.Jt)("/username?id="+e).then((e=>(localStorage.setItem("name",e.data.name),this.user_name=e.data.name,!0))).catch((e=>{if("Network Error"!=e.message)return 401==e.response.status&&this.$router.push("/login"),"false"}))},init_ws_chat(e){this.websocket=(0,Z.jA)("/ws?id="+e),this.websocket.onopen=()=>{console.log("socket is open"),this.connection_ready=!0,this.connection_error=!1},this.websocket.onmessage=this.onSocketMesssage,this.websocket.onerror=this.onSockerError},onSocketMesssage(e){let s=new Uint8Array(e.data);switch(s[0]){case 0:this.controlCommandDecode(s.subarray(1));break;case 1:this.dataMessageDecode(s.subarray(1));break;case 3:this.errorMessageDecode(s.subarray(1));break}},onSockerError(e){this.connection_error=!0,this.connection_ready=!1,console.log(e)},send_message(){this.data.clear(),1==this.isRoom?this.data.RoomId=this.selected_room.id:this.data.UserId=this.selected_room.id;let e=this.findRoom(this.selected_room.id);if(this.data.IndexNumber=e.messages.length+1,this.data.DataMessageType.value=1,""!=this.imageSrc){1==this.isCompressImage&&(this.imageSrc=this.compressImage(this.imageSrc));let s=atob(this.imageSrc.slice(23));this.data.DataMessageFormat.value=2,this.sendBySocket(s),e.messages.push({from:"me",type:"image",message:this.imageSrc,err:!1}),this.closePreview()}""!=this.text&&(this.data.DataMessageFormat.value=1,this.sendBySocket(this.text),e.messages.push({from:"me",type:"text",message:this.text,err:!1}),this.text="")},sendBySocket(e){let s=new TextEncoder,t=s.encode(e);if(t.length>this.assembler.maxLength){this.data.UserData.Fragmentation.On=!0,this.assembler.fullMessage=t;let e=this.assembler.fragmentation();for(let s=1;s<=e.length;s++)1==s?this.data.UserData.Fragmentation.FragmentType=2:s==e.length?this.data.UserData.Fragmentation.FragmentType=1:this.data.UserData.Fragmentation.FragmentType=0,this.data.UserData.Fragmentation.Counter=s,this.data.UserData.Data=e[s-1],this.websocket.send(this.data.code())}else this.data.UserData.Data=t,this.websocket.send(this.data.code())},controlCommandDecode(e){this.control.clear(),this.control.decode(e),this.processingControlCommand()},processingControlCommand(){switch(this.control.ControlMessageType.value){case Ve.T.ControlMessage.UserNameResponse:this.user_name=this.control.UserName;break;case Ve.T.ControlMessage.Connect:this.connectUser(this.control.UserId);break;case Ve.T.ControlMessage.Disconnect:this.disconnectUser(this.control.UserId);break;case Ve.T.ControlMessage.Registration:this.registrationNewUser(this.control.UserId,this.control.UserName);break;case Ve.T.ControlMessage.UserUpdate:break;case Ve.T.ControlMessage.UsersList:this.processingUsersList(this.control);break;case Ve.T.ControlMessage.NumberOfMessages:this.fillMessageList(this.control.NumberOfMessages.NumOfMessages);break;default:break}},dataMessageDecode(e){this.data.clear(),this.data.decode(e);let s={from:"me",name:"",type:"",data:"",room:0,indexNumber:0};if(1==this.data.UserData.Fragmentation.On){this.assembler.clear();let e=0;e=0==isNaN(this.data.RoomId)?this.data.RoomId:this.data.UserId;let s={id:e,type:this.data.UserData.Fragmentation.FragmentType,number:this.data.UserData.Fragmentation.Counter,data:this.data.UserData.Data};if(this.assembler.message=s,this.assembler.assembling(),null==this.assembler.fullMessage)return;this.data.UserData.Data=this.assembler.fullMessage}let t=new TextDecoder,i=t.decode(this.data.UserData.Data);switch(this.data.UserId!=this.id&&(s.from="other",s.name=this.nameFromId(this.data.UserId)),s.type=this.data.DataMessageFormat.toString(),"image"==this.data.DataMessageFormat.toString()&&(s.data=`data:image/jpeg;base64,${btoa(i)}`),"text"==this.data.DataMessageFormat.toString()&&(s.data=i),this.data.DataMessageType.toString()){case"new message":s.name=this.nameFromId(this.data.UserId),0==isNaN(this.data.RoomId)?(s.room=this.data.RoomId,this.setActiveMessageInRoom(this.data.RoomId)):(s.room=this.data.UserId,this.setActiveMessageInList(this.data.UserId)),this.newMessageProcessing(s);break;case"old message":if(1==isNaN(this.data.RoomId))break;s.room=this.data.RoomId,s.indexNumber=this.data.IndexNumber,this.oldMessageProcessing(s);break;default:break}},newMessageProcessing(e){let s=this.findRoom(e.room);s.messages.push({from:"other",name:e.name,type:e.type,message:e.data,err:!1});const t=document.getElementById("messages");t.scrollTo({top:t.scrollHeight,behavior:"smooth"})},oldMessageProcessing(e){let s=this.findRoom(e.room);s.lastLoadedNumber=e.indexNumber,this.selected_room.lastLoadedNumber=e.indexNumber,s.messages.length<e.indexNumber?s.messages.push({from:e.from,name:e.name,type:e.type,message:e.data,err:!1}):(s.messages[e.indexNumber-1].from=e.from,s.messages[e.indexNumber-1].name=e.name,s.messages[e.indexNumber-1].type=e.type,s.messages[e.indexNumber-1].message=e.data);const t=document.getElementById("messages");t.scrollTo({top:t.scrollHeight})},errorMessageDecode(e){let s=Ve.T.Error;if(s.clear(),s.decode(e),"data"==s.ErrMessageType.toString()){let e=this.findRoom(s.UserId);if(e.messages.length<s.IndexNumber)return;e.messages[s.IndexNumber-1].err=!0}},connectUser(e){this.selected_room.id==e&&(this.selected_room.online=!0);for(let s=0;s<this.list.length;s++)if(this.list[s].id==e)return void(this.list[s].online=!0)},disconnectUser(e){this.selected_room.id==e&&(this.selected_room.online=!1);for(let s=0;s<this.list.length;s++)if(this.list[s].id==e)return void(this.list[s].online=!1)},registrationNewUser(e,s){this.list.push({id:e,name:s,online:!1,isActiveMessage:!1,numOfMessages:0});let t=this.findRoom(0);t.messages.push({from:"other",name:s,message:"Зарегестрирован новый пользователь",err:!1})},processingUsersList(e){let s=!1;"set list"!=e.UsersList.ListCommand&&"refresh list"!=e.ListCommand||(this.list.length=0,this.rooms.length=1);for(let t of e.UsersList.ListElements)s=0!=t[1].nrm,this.list.push({id:t[0],name:t[1].name,online:t[1].online,isActiveMessage:s,numOfMessages:t[1].nrm}),this.rooms.push({id:t[0],lastLoadedNumber:0,messages:[]})},fillMessageList(e){if(0==e)return;let s=this.findRoom(this.selected_room.id);for(let t=0;t<e;t++)s.messages.push({from:"me",name:"",type:"text",message:"",err:!1});this.selected_room.lastLoadedNumber=e,this.$nextTick((()=>this.observeMessages()))},findRoom(e){for(let s=0;s<this.rooms.length;s++)if(this.rooms[s].id==e)return this.rooms[s]},nameFromId(e){for(let s=0;s<this.list.length;s++)if(this.list[s].id==e)return this.list[s].name},setActiveMessageInRoom(e){for(let s=0;s<this.roomsList.length;s++)if(this.roomsList[s].id==e)return this.roomsList[s].isActiveMessage=!0,void this.roomsList[s].numOfMessages++},setActiveMessageInList(e){for(let s=0;s<this.list.length;s++)if(this.list[s].id==e)return this.list[s].isActiveMessage=!0,void this.list[s].numOfMessages++},logout(){let e={id:this.id};(0,Z.bE)("/logout",e).then((()=>{localStorage.removeItem("name"),this.websocket.close(1e3,"работа закончена"),this.$router.push("/login")})).catch((e=>{console.log(e)}))},setUserName(){return this.user_name},showEditUser(){this.isShowEditUser=!0},showEmoji(){this.isEmoji=!0},closeEmoji(e){(void 0==e||e.offsetY>0)&&(this.isEmoji=!1)},closeEditUser(){this.isShowEditUser=!1},showChangePass(){this.isShowChangePass=!0,this.isShowEditUser=!1},closeChangePass(){this.isShowChangePass=!1,this.isShowEditUser=!0},userListClick(e){if(null==this.websocket)return;this.isRoom=!1,1==e.isActiveMessage&&(e.isActiveMessage=!1,this.setReaded(e.id)),e.numOfActiveMessages=0,this.selected_room.id=e.id,this.selected_room.name=e.name,this.selected_room.online=e.online;let s=this.findRoom(this.selected_room.id);null!=s&&(this.selected_room.lastLoadedNumber=s.lastLoadedNumber,0==s.lastLoadedNumber?this.askMessagesFromSErver():this.$nextTick((()=>{const e=document.getElementById("messages");e.scrollTo({top:e.scrollHeight}),0!=s.messages.length&&1!=s.lastLoadedNumber&&this.observeMessages()})))},askMessagesFromSErver(){null!=this.websocket&&(this.control.clear(),this.control.ControlMessageType.value=Ve.T.ControlMessage.MessagesRequest,this.control.MessagesRequest.RoomId=this.selected_room.id,this.control.MessagesRequest.LastMessageNumber=this.selected_room.lastLoadedNumber,this.websocket.send(this.control.code()))},observeMessages(){this.observerOptions.root=document.getElementById("messages");const e=new IntersectionObserver(this.loadMessages,this.observerOptions),s=document.querySelectorAll(".message");0!=s.length&&s.forEach((s=>{e.observe(s)}))},messageSpaceClick(){if(this.isRoom){for(let e=0;e<this.roomsList.length;e++)if(this.roomsList[e].id==this.selected_room.id)return this.roomsList[e].isActiveMessage=!1,void(this.roomsList[e].numOfMessages=0)}else for(let e=0;e<this.list.length;e++)if(this.list[e].id==this.selected_room.id)return 1==this.list[e].isActiveMessage&&(this.list[e].isActiveMessage=!1,this.setReaded(this.selected_room.id)),void(this.list[e].numOfMessages=0)},roomClick(e){this.isRoom=!0,e.isActiveMessage=!1,e.numOfActiveMessages=0,this.selected_room.id=e.id,this.selected_room.name=e.name},roomSelected(e){return e==this.selected_room.id},setReaded(e){let s=Ve.T.Acknowledge;s.clear(),s.AckMessageType.value=3,s.UserId=e,this.websocket.send(s.code())},compressImage(e){let s=document.createElement("canvas"),t=new Image;t.src=e;let i=t.width,a=t.height;const o=200,r=200;i>a?i>o&&(a=Math.round(a*=o/i),i=o):a>r&&(i=Math.round(i*=r/a),a=r),s.width=i,s.height=a;let n=s.getContext("2d");return n.drawImage(t,0,0,i,a),s.toDataURL("image/jpeg",.7)},loadImage(e){let s=e.target;if(s.files&&s.files[0]){let e=new FileReader,t=this;e.onload=function(e){t.imageSrc=e.target.result,t.isImage=!0},e.readAsDataURL(s.files[0])}},popUpImage(e){this.isShowImagePreview=!0,this.popUpImgSrc=e},closePopUpImage(){this.isShowImagePreview=!1,this.popUpImgSrc=""},closePreview(){this.$refs.imgUpload.value=null,this.imageSrc="",this.isImage=!1},showSendBtn(){return""!=this.text||""!=this.imageSrc},set_emoji(e){document.getElementById("add_text").value+=e.value,this.text+=e.value},loadMessages(e){let s=0;e.forEach((e=>{s++,e.intersectionRatio>0&&s<this.selected_room.lastLoadedNumber&&this.askMessagesFromSErver()}))}},computed:{filteredList(){let e=this.filter_name;return this.list.filter((s=>s.name.toLowerCase().includes(e.toLowerCase())))},indexOfSelectedRoom(){for(let e=0;e<this.rooms.length;e++)if(this.rooms[e].id==this.selected_room.id)return e;return-1}},updated(){}};const qe=(0,se.A)(Je,[["render",A],["__scopeId","data-v-d11d08d8"]]);var Ke=qe}}]);
//# sourceMappingURL=151.ca729c31.js.map