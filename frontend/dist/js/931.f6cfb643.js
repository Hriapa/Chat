"use strict";(self["webpackChunkwebserver"]=self["webpackChunkwebserver"]||[]).push([[931],{1931:function(e,s,t){t.r(s),t.d(s,{default:function(){return Ye}});var a=t(6768),i=t(5130),o=t(4232);const r=e=>((0,a.Qi)("data-v-4a43c16e"),e=e(),(0,a.jt)(),e),n={class:"container-chat"},l={class:"chat_sidebar"},d={class:"search"},m=["onClick"],c={key:0,class:"recieve_message"},h=["onClick"],u={key:0,class:"recieve_message"},g={class:"chat_content"},p={class:"header"},f={class:"selected_room"},k={key:0,class:"error"},_={class:"header_right"},v={class:"user"},b={class:"message_container"},w=["id"],L={key:0,class:"error"},y={class:"msg_name"},U={key:1,class:"text"},C=["src","onClick"],I={class:"chat_footer"},M={class:"image_preview"},E={class:"image"},S=r((()=>(0,a.Lk)("i",{class:"icon i_close"},null,-1))),R=[S],x=["src"],N={class:"image_options"},T=r((()=>(0,a.Lk)("p",null,"Сжать изображение",-1))),A={class:"text_field"},D=r((()=>(0,a.Lk)("label",{for:"add_pic"},[(0,a.Lk)("i",{class:"i_add_pic icon","data-title":"Add picture"})],-1)));function j(e,s,t,r,S,j){const P=(0,a.g2)("EditUser"),F=(0,a.g2)("ChangePass"),X=(0,a.g2)("EmojiPicker"),O=(0,a.g2)("ImagePreview");return(0,a.uX)(),(0,a.CE)(a.FK,null,[S.isShowEditUser?((0,a.uX)(),(0,a.Wv)(P,{key:0,edit_user_param:S.edit_user_param,name:S.user_info.name,"onUpdate:name":s[0]||(s[0]=e=>S.user_info.name=e),surname:S.user_info.surname,"onUpdate:surname":s[1]||(s[1]=e=>S.user_info.surname=e),familyname:S.user_info.familyname,"onUpdate:familyname":s[2]||(s[2]=e=>S.user_info.familyname=e),birthday:S.user_info.birthday,"onUpdate:birthday":s[3]||(s[3]=e=>S.user_info.birthday=e),onAskUserInfo:j.askUserInfo,onUpdateUser:j.updateUser,onCloseEdit:j.closeEditUser,onChangePass:j.showChangePass},null,8,["edit_user_param","name","surname","familyname","birthday","onAskUserInfo","onUpdateUser","onCloseEdit","onChangePass"])):(0,a.Q3)("",!0),S.isShowChangePass?((0,a.uX)(),(0,a.Wv)(F,{key:1,onClose:j.closeChangePass,user_id:S.id},null,8,["onClose","user_id"])):(0,a.Q3)("",!0),(0,a.bF)(i.eB,{name:"picker"},{default:(0,a.k6)((()=>[S.isEmoji?((0,a.uX)(),(0,a.Wv)(X,{key:0,onSet_emoji:j.set_emoji,onClose:j.closeEmoji},null,8,["onSet_emoji","onClose"])):(0,a.Q3)("",!0)])),_:1}),S.isShowImagePreview?((0,a.uX)(),(0,a.Wv)(O,{key:2,onClose:j.closePopUpImage,img:S.popUpImgSrc},null,8,["onClose","img"])):(0,a.Q3)("",!0),(0,a.Lk)("div",n,[(0,a.Lk)("div",l,[(0,a.Lk)("div",d,[(0,a.bo)((0,a.Lk)("input",{type:"search","onUpdate:modelValue":s[4]||(s[4]=e=>S.filter_name=e),id:"search",placeholder:"Поиск...",autocomplete:"off"},null,512),[[i.Jo,S.filter_name]])]),(0,a.Lk)("ul",null,[((0,a.uX)(!0),(0,a.CE)(a.FK,null,(0,a.pI)(S.roomsList,(e=>((0,a.uX)(),(0,a.CE)("li",{key:e.id,onClick:s=>j.roomClick(e),class:(0,o.C4)(["room",{selected:j.roomSelected(e.id)}])},[(0,a.eW)((0,o.v_)(e.name)+" ",1),e.isActiveMessage?((0,a.uX)(),(0,a.CE)("span",c,(0,o.v_)(e.numOfMessages),1)):(0,a.Q3)("",!0)],10,m)))),128))]),(0,a.Lk)("ul",null,[((0,a.uX)(!0),(0,a.CE)(a.FK,null,(0,a.pI)(j.filteredList,(e=>((0,a.uX)(),(0,a.CE)("li",{key:e.id,onClick:s=>j.userListClick(e),class:(0,o.C4)({selected:j.roomSelected(e.id)})},[(0,a.Lk)("p",{class:(0,o.C4)({online:e.online})},[(0,a.eW)((0,o.v_)(e.name)+" ",1),(0,a.Lk)("i",{class:(0,o.C4)(["status",{status_online:e.online}])},null,2)],2),e.isActiveMessage?((0,a.uX)(),(0,a.CE)("span",u,(0,o.v_)(e.numOfMessages),1)):(0,a.Q3)("",!0)],10,h)))),128))])]),(0,a.Lk)("section",g,[(0,a.Lk)("div",p,[(0,a.Lk)("div",f,[(0,a.Lk)("h1",null,(0,o.v_)(S.selected_room.name),1),(0,a.bo)((0,a.Lk)("i",{class:(0,o.C4)(["icon",{i_online:S.selected_room.online,i_offline:!S.selected_room.online}])},null,2),[[i.aG,!S.isRoom]])]),(0,a.Lk)("h2",null,[S.connection_error?((0,a.uX)(),(0,a.CE)("span",k,"network connection error")):(0,a.Q3)("",!0)]),(0,a.Lk)("div",_,[(0,a.Lk)("p",v,(0,o.v_)(j.setUserName()),1),(0,a.Lk)("button",{onClick:s[5]||(s[5]=(...e)=>j.showEditUser&&j.showEditUser(...e)),class:"i_properties icon"}),(0,a.Lk)("button",{onClick:s[6]||(s[6]=(...e)=>j.logout&&j.logout(...e)),class:"i_logout icon"})])]),(0,a.Lk)("div",b,[(0,a.Lk)("div",{class:"messages",id:"messages",onClick:s[7]||(s[7]=e=>j.messageSpaceClick())},[((0,a.uX)(!0),(0,a.CE)(a.FK,null,(0,a.pI)(S.rooms[j.indexOfSelectedRoom].messages,((e,s)=>((0,a.uX)(),(0,a.CE)("div",{key:"m-"+s,class:"message",id:s+1},[(0,a.Lk)("div",{class:(0,o.C4)({send:"me"==e.from,response:"other"==e.from})},[(0,a.Lk)("ul",null,[1==e.err?((0,a.uX)(),(0,a.CE)("li",L,"Ошибка отправки сообщения")):(0,a.Q3)("",!0),(0,a.Lk)("li",y,(0,o.v_)(e.name),1),"text"==e.type?((0,a.uX)(),(0,a.CE)("li",U,(0,o.v_)(e.message),1)):(0,a.Q3)("",!0),"image"==e.type?((0,a.uX)(),(0,a.CE)("img",{key:2,src:e.message,onClick:s=>j.popUpImage(e.message)},null,8,C)):(0,a.Q3)("",!0)])],2)],8,w)))),128))])]),(0,a.Lk)("div",I,[(0,a.bo)((0,a.Lk)("div",M,[(0,a.Lk)("div",E,[(0,a.Lk)("div",{class:"close_preview",onClick:s[8]||(s[8]=(...e)=>j.closePreview&&j.closePreview(...e))},R),(0,a.Lk)("img",{src:S.imageSrc},null,8,x)]),(0,a.Lk)("div",N,[(0,a.bo)((0,a.Lk)("input",{type:"checkbox",name:"compress image",id:"","onUpdate:modelValue":s[9]||(s[9]=e=>S.isCompressImage=e)},null,512),[[i.lH,S.isCompressImage]]),T])],512),[[i.aG,S.isImage]]),(0,a.Lk)("div",A,[(0,a.bo)((0,a.Lk)("input",{"onUpdate:modelValue":s[10]||(s[10]=e=>S.text=e),type:"text",id:"add_text",placeholder:"Сообщение...",onKeyup:s[11]||(s[11]=(0,i.jR)(((...e)=>j.send_message&&j.send_message(...e)),["enter"]))},null,544),[[i.Jo,S.text]]),(0,a.Lk)("i",{class:"i_emoji icon",onMouseenter:s[12]||(s[12]=(...e)=>j.showEmoji&&j.showEmoji(...e)),onMouseleave:s[13]||(s[13]=(...e)=>j.closeEmoji&&j.closeEmoji(...e))},null,32),(0,a.Lk)("input",{type:"file",accept:"image/*",id:"add_pic","on:change":s[14]||(s[14]=(...e)=>j.loadImage&&j.loadImage(...e)),ref:"imgUpload"},null,544),D,j.showSendBtn()?((0,a.uX)(),(0,a.CE)("i",{key:0,class:"i_send icon",onClick:s[15]||(s[15]=(...e)=>j.send_message&&j.send_message(...e)),"data-title":"Send message"})):(0,a.Q3)("",!0)])])])])],64)}t(4114),t(6573),t(8100),t(7936),t(7467),t(4732),t(9577),t(4979);const P=e=>((0,a.Qi)("data-v-2ffba603"),e=e(),(0,a.jt)(),e),F={class:"popup_wrapper",ref:"popup_wrapper"},X={class:"edit_popup"},O={key:0,class:"reuslt_ok"},$={key:1,class:"result_err"},Q={class:"blok"},B=P((()=>(0,a.Lk)("label",{for:"name"},"Имя:",-1))),q=["value"],K={class:"blok"},V=P((()=>(0,a.Lk)("label",{for:"familyname"},"Фамилия:",-1))),W=["value"],H={class:"blok"},G=P((()=>(0,a.Lk)("label",{for:"surname"},"Отчество:",-1))),J=["value"],Y={class:"blok"},z=P((()=>(0,a.Lk)("label",{for:"birthdate"},"Дата Рождения:",-1))),Z=["value"],ee={class:"change_pass"},se={class:"edit_footer"};function te(e,s,t,i,r,n){return(0,a.uX)(),(0,a.CE)("div",F,[(0,a.Lk)("div",X,[(0,a.Lk)("div",null,[t.edit_user_param.ok?((0,a.uX)(),(0,a.CE)("p",O,"Данные успешно обновлены")):(0,a.Q3)("",!0),t.edit_user_param.err?((0,a.uX)(),(0,a.CE)("p",$,(0,o.v_)(t.edit_user_param.errString),1)):(0,a.Q3)("",!0)]),(0,a.Lk)("div",Q,[B,(0,a.Lk)("input",{type:"text",id:"name",value:t.name,onInput:s[0]||(s[0]=s=>e.$emit("update:name",s.target.value))},null,40,q)]),(0,a.Lk)("div",K,[V,(0,a.Lk)("input",{type:"text",id:"familyname",value:t.familyname,onInput:s[1]||(s[1]=s=>e.$emit("update:familyname",s.target.value))},null,40,W)]),(0,a.Lk)("div",H,[G,(0,a.Lk)("input",{type:"text",id:"surname",value:t.surname,onInput:s[2]||(s[2]=s=>e.$emit("update:surname",s.target.value))},null,40,J)]),(0,a.Lk)("div",Y,[z,(0,a.Lk)("input",{type:"date",id:"birthday",value:t.birthday,onInput:s[3]||(s[3]=s=>e.$emit("update:birthday",s.target.value))},null,40,Z)]),(0,a.Lk)("div",ee,[(0,a.Lk)("button",{onClick:s[4]||(s[4]=(...e)=>n.changePass&&n.changePass(...e))},"Сменить пароль")]),(0,a.Lk)("div",se,[(0,a.Lk)("button",{class:"save",onClick:s[5]||(s[5]=(...e)=>n.updateUserInfo&&n.updateUserInfo(...e))},"Сохранить"),(0,a.Lk)("button",{class:"close",onClick:s[6]||(s[6]=(...e)=>n.closeEdit&&n.closeEdit(...e))},"Закрыть")])])],512)}var ae={props:{name:{type:String,default:""},surname:{type:String,default:""},familyname:{type:String,default:""},birthday:{type:String,default:""},edit_user_param:{type:Object,default:()=>({ok:!1,err:!1,errString:""})}},data(){return{}},mounted(){this.askUserInfo();let e=this;document.addEventListener("click",(function(s){s.target==e.$refs["popup_wrapper"]&&e.closeEdit()}))},methods:{closeEdit(){this.$emit("closeEdit")},askUserInfo(){this.$emit("askUserInfo")},changePass(){this.$emit("changePass")},updateUserInfo(){this.$emit("updateUser")}},computed(){}},ie=t(1241);const oe=(0,ie.A)(ae,[["render",te],["__scopeId","data-v-2ffba603"]]);var re=oe;const ne=e=>((0,a.Qi)("data-v-5d64629d"),e=e(),(0,a.jt)(),e),le={class:"popup_wrapper",ref:"popup_wrapper"},de={class:"change_popup"},me={class:"close"},ce=ne((()=>(0,a.Lk)("h1",null,"Сменить пароль",-1))),he={class:"error"},ue=ne((()=>(0,a.Lk)("p",null,"Пороль обновлён",-1))),ge=[ue],pe={class:"input"},fe=["type"],ke={class:"input"},_e=["type"],ve={key:0,class:"input"},be=["type"],we={class:"check_block"},Le={class:"check"},ye=ne((()=>(0,a.Lk)("label",{for:"show_pass"},"Показать пароль",-1))),Ue={class:"button_block"},Ce=["disabled"];function Ie(e,s,t,r,n,l){return(0,a.uX)(),(0,a.CE)("div",le,[(0,a.Lk)("div",de,[(0,a.Lk)("form",{onSubmit:s[5]||(s[5]=(0,i.D$)(((...e)=>l.changePass&&l.changePass(...e)),["prevent"]))},[(0,a.Lk)("div",me,[(0,a.Lk)("p",{onClick:s[0]||(s[0]=(...e)=>l.close&&l.close(...e)),title:"Закрыть"},"X")]),ce,(0,a.bo)((0,a.Lk)("div",he,[(0,a.Lk)("p",null,"Error: "+(0,o.v_)(n.errResult),1)],512),[[i.aG,n.isEroor]]),(0,a.bo)((0,a.Lk)("div",null,ge,512),[[i.aG,n.isResult]]),(0,a.Lk)("div",pe,[(0,a.bo)((0,a.Lk)("input",{required:"",type:n.show_pass?"text":"password",placeholder:"текущий пароль","onUpdate:modelValue":s[1]||(s[1]=e=>n.old_password=e)},null,8,fe),[[i.hp,n.old_password]])]),(0,a.Lk)("div",ke,[(0,a.bo)((0,a.Lk)("input",{required:"",type:n.show_pass?"text":"password",placeholder:"новый пароль","onUpdate:modelValue":s[2]||(s[2]=e=>n.new_password=e)},null,8,_e),[[i.hp,n.new_password]])]),l.confirm?((0,a.uX)(),(0,a.CE)("div",ve,[(0,a.bo)((0,a.Lk)("input",{required:"",type:n.show_pass?"text":"password",placeholder:"подтвердите пароль","onUpdate:modelValue":s[3]||(s[3]=e=>n.confirmed_password=e)},null,8,be),[[i.hp,n.confirmed_password]])])):(0,a.Q3)("",!0),(0,a.Lk)("div",we,[(0,a.Lk)("div",Le,[(0,a.bo)((0,a.Lk)("input",{type:"checkbox",id:"show_pass","onUpdate:modelValue":s[4]||(s[4]=e=>n.show_pass=e)},null,512),[[i.lH,n.show_pass]]),ye])]),(0,a.Lk)("div",Ue,[(0,a.Lk)("button",{type:"submit",disabled:!l.check_pass,class:(0,o.C4)(l.check_pass?"activ":"non_activ")},"Подтвердить",10,Ce)])],32)])],512)}var Me=t(7416),Ee={props:{user_id:Number},data(){return{old_password:"",new_password:"",confirmed_password:"",show_pass:!1,isResult:!1,isEroor:!1,errResult:""}},mounted(){let e=this;document.addEventListener("click",(function(s){s.target==e.$refs["popup_wrapper"]&&e.close()}))},methods:{changePass(){let e={id:this.user_id,old:this.old_password,new:this.new_password};(0,Me.bE)("/changepass",e).then((()=>{this.isResult=!0,this.isEroor=!1})).catch((e=>{this.isResult=!1,this.isEroor=!0,this.errResult=e.response.data}))},close(){this.$emit("close")}},computed:{confirm(){return this.new_password.length>4},check_pass(){return!(this.new_password.length<4)&&this.new_password==this.confirmed_password}}};const Se=(0,ie.A)(Ee,[["render",Ie],["__scopeId","data-v-5d64629d"]]);var Re=Se;const xe=e=>((0,a.Qi)("data-v-55979468"),e=e(),(0,a.jt)(),e),Ne={class:"popup_wrapper",ref:"popup_wrapper"},Te={class:"img_preview"},Ae=xe((()=>(0,a.Lk)("i",{class:"icon i_close"},null,-1))),De=[Ae],je=["src"];function Pe(e,s,t,i,o,r){return(0,a.uX)(),(0,a.CE)("div",Ne,[(0,a.Lk)("div",Te,[(0,a.Lk)("div",{onClick:s[0]||(s[0]=(...e)=>r.close&&r.close(...e))},De),(0,a.Lk)("img",{src:t.img},null,8,je)])],512)}var Fe={props:{img:{type:String,default:""}},mounted(){let e=this;document.addEventListener("click",(function(s){s.target==e.$refs["popup_wrapper"]&&e.close()}))},methods:{close(){this.$emit("close")}}};const Xe=(0,ie.A)(Fe,[["render",Pe],["__scopeId","data-v-55979468"]]);var Oe=Xe;const $e={class:"emojis_conteiner"},Qe={class:"emoji"},Be=["title","onClick"];function qe(e,s,t,i,r,n){return(0,a.uX)(),(0,a.CE)("div",{class:"emoji_picker",onMouseleave:s[0]||(s[0]=(...e)=>n.close&&n.close(...e))},[(0,a.Lk)("div",$e,[((0,a.uX)(!0),(0,a.CE)(a.FK,null,(0,a.pI)(this.emojis,((e,s)=>((0,a.uX)(),(0,a.CE)("div",{key:s},[(0,a.Lk)("h5",null,(0,o.v_)(s),1),(0,a.Lk)("div",Qe,[((0,a.uX)(!0),(0,a.CE)(a.FK,null,(0,a.pI)(e,((e,s)=>((0,a.uX)(),(0,a.CE)("span",{key:s,title:s,onClick:s=>n.set_emoji(e)},(0,o.v_)(e),9,Be)))),128))])])))),128))])],32)}var Ke={data(){return{emojis:{"face-smiling":{"grinning face":"😀","grinning face with big eyes":"😃","grinning face with smiling eyes":"😄","beaming face with smiling eyes":"😁"},"face-affection":{"smiling face with hearts":"🥰","smiling face with heart-eyes":"😍","star-struck":"🤩","face blowing a kiss":"😘"}},emoji:""}},methods:{set_emoji(e){this.emoji=e,this.$emit("set_emoji",{value:this.emoji})},close(){this.$emit("close")}}};const Ve=(0,ie.A)(Ke,[["render",qe]]);var We=Ve,He=t(4652),Ge={components:{EditUser:re,ChangePass:Re,ImagePreview:Oe,EmojiPicker:We},data(){return{id:0,user_name:"",user_info:{name:"",surname:"",familyname:"",birthday:""},edit_user_param:{ok:!1,err:!1,errString:""},isShowEditUser:!1,isShowChangePass:!1,isEmoji:!1,isShowImagePreview:!1,isImage:!1,isCompressImage:!0,imageSrc:"",popUpImgSrc:"",roomsList:[{id:0,name:"Общие",isActiveMessage:!1,numOfActiveMessages:0}],list:[{id:0,name:"",online:!1,isActiveMessage:!1,numOfActiveMessages:0}],filter_name:"",isRoom:!0,selected_room:{id:0,name:"Общие",online:!1,lastLoadedNumber:0},rooms:[{id:0,lastLoadedNumber:0,messages:[]}],connection_ready:!1,connection_error:!0,websocket:null,control:He.T.ControlCommand,data:He.T.Data,assembler:He.T.assembler,text:"",messages:[],selectRoomMessages:[],observerOptions:{root:null,rootMargin:"0px",threshold:.1}}},mounted(){this.init_chat()},methods:{init_chat(){(0,Me.Jt)("/chat").then((e=>{this.id=e.data.user,parseInt(localStorage.getItem("id"))!=this.id&&(localStorage.clear(),localStorage.setItem("id",this.id)),null==localStorage.getItem("name")?this.ask_name(this.id):this.user_name=localStorage.getItem("name"),this.init_ws_chat(this.id)})).catch((e=>{if("Network Error"!=e.message)return 401==e.response.status&&this.$router.push("/login"),"false"}))},ask_name(e){(0,Me.Jt)("/username?id="+e).then((e=>(localStorage.setItem("name",e.data.name),this.user_name=e.data.name,!0))).catch((e=>{if("Network Error"!=e.message)return 401==e.response.status&&this.$router.push("/login"),"false"}))},init_ws_chat(e){this.websocket=(0,Me.jA)("/ws?id="+e),this.websocket.onopen=()=>{console.log("socket is open"),this.connection_ready=!0,this.connection_error=!1},this.websocket.onmessage=this.onSocketMesssage,this.websocket.onerror=this.onSockerError},onSocketMesssage(e){let s=new Uint8Array(e.data);switch(s[0]){case 0:this.controlCommandDecode(s.subarray(1));break;case 1:this.dataMessageDecode(s.subarray(1));break;case 2:this.ackMessageDecode(s.subarray(1));break;case 3:this.errorMessageDecode(s.subarray(1));break}},onSockerError(e){this.connection_error=!0,this.connection_ready=!1,console.log(e)},send_message(){this.data.clear(),1==this.isRoom?this.data.RoomId=this.selected_room.id:this.data.UserId=this.selected_room.id;let e=this.findRoom(this.selected_room.id);if(this.data.IndexNumber=e.messages.length+1,this.data.DataMessageType.value=1,""!=this.imageSrc){1==this.isCompressImage&&(this.imageSrc=this.compressImage(this.imageSrc));let s=atob(this.imageSrc.slice(23));this.data.DataMessageFormat.value=2,this.sendBySocket(s),e.messages.push({from:"me",type:"image",message:this.imageSrc,err:!1}),this.closePreview()}""!=this.text&&(this.data.DataMessageFormat.value=1,this.sendBySocket(this.text),e.messages.push({from:"me",type:"text",message:this.text,err:!1}),this.text="")},sendBySocket(e){let s=new TextEncoder,t=s.encode(e);if(t.length>this.assembler.maxLength){this.data.UserData.Fragmentation.On=!0,this.assembler.fullMessage=t;let e=this.assembler.fragmentation();for(let s=1;s<=e.length;s++)1==s?this.data.UserData.Fragmentation.FragmentType=2:s==e.length?this.data.UserData.Fragmentation.FragmentType=1:this.data.UserData.Fragmentation.FragmentType=0,this.data.UserData.Fragmentation.Counter=s,this.data.UserData.Data=e[s-1],this.websocket.send(this.data.code())}else this.data.UserData.Data=t,this.websocket.send(this.data.code())},controlCommandDecode(e){this.control.clear(),this.control.decode(e),this.processingControlCommand()},processingControlCommand(){switch(this.control.ControlMessageType.value){case He.T.ControlMessage.UserNameResponse:this.user_name=this.control.UserName;break;case He.T.ControlMessage.Connect:this.connectUser(this.control.UserId);break;case He.T.ControlMessage.Disconnect:this.disconnectUser(this.control.UserId);break;case He.T.ControlMessage.Registration:this.registrationNewUser(this.control.UserId,this.control.UserName);break;case He.T.ControlMessage.UserUpdate:this.userUpdate(this.control.UserId,this.control.UserName);break;case He.T.ControlMessage.UserInfoResponse:this.fillUserInfo();break;case He.T.ControlMessage.UsersList:this.processingUsersList(this.control);break;case He.T.ControlMessage.NumberOfMessages:this.fillMessageList(this.control.NumberOfMessages.NumOfMessages);break;default:break}},dataMessageDecode(e){this.data.clear(),this.data.decode(e);let s={from:"me",name:"",type:"",data:"",room:0,indexNumber:0};if(1==this.data.UserData.Fragmentation.On){this.assembler.clear();let e=0;e=0==isNaN(this.data.RoomId)?this.data.RoomId:this.data.UserId;let s={id:e,type:this.data.UserData.Fragmentation.FragmentType,number:this.data.UserData.Fragmentation.Counter,data:this.data.UserData.Data};if(this.assembler.message=s,this.assembler.assembling(),null==this.assembler.fullMessage)return;this.data.UserData.Data=this.assembler.fullMessage}let t=new TextDecoder,a=t.decode(this.data.UserData.Data);switch(this.data.UserId!=this.id&&(s.from="other",s.name=this.nameFromId(this.data.UserId)),s.type=this.data.DataMessageFormat.toString(),"image"==this.data.DataMessageFormat.toString()&&(s.data=`data:image/jpeg;base64,${btoa(a)}`),"text"==this.data.DataMessageFormat.toString()&&(s.data=a),this.data.DataMessageType.toString()){case"new message":s.name=this.nameFromId(this.data.UserId),0==isNaN(this.data.RoomId)?(s.room=this.data.RoomId,this.setActiveMessageInRoom(this.data.RoomId)):(s.room=this.data.UserId,this.setActiveMessageInList(this.data.UserId)),this.newMessageProcessing(s);break;case"old message":if(1==isNaN(this.data.RoomId))break;s.room=this.data.RoomId,s.indexNumber=this.data.IndexNumber,this.oldMessageProcessing(s);break;default:break}},newMessageProcessing(e){let s=this.findRoom(e.room);s.messages.push({from:"other",name:e.name,type:e.type,message:e.data,err:!1});const t=document.getElementById("messages");t.scrollTo({top:t.scrollHeight,behavior:"smooth"})},oldMessageProcessing(e){let s=this.findRoom(e.room);s.lastLoadedNumber=e.indexNumber,this.selected_room.lastLoadedNumber=e.indexNumber,s.messages.length<e.indexNumber?s.messages.push({from:e.from,name:e.name,type:e.type,message:e.data,err:!1}):(s.messages[e.indexNumber-1].from=e.from,s.messages[e.indexNumber-1].name=e.name,s.messages[e.indexNumber-1].type=e.type,s.messages[e.indexNumber-1].message=e.data);const t=document.getElementById("messages");t.scrollTo({top:t.scrollHeight})},ackMessageDecode(e){let s=He.T.Acknowledge;if(s.clear(),s.decode(e),"control"==s.AckMessageType.toString())switch(s.ControlAckType.value){case 1:this.edit_user_param.ok=!0;break}},errorMessageDecode(e){let s=He.T.Error;if(s.clear(),s.decode(e),"control"==s.ErrMessageType.toString())switch(s.ControlMessageType.value){case this.protocol.ControlMessage.UserInfoUpdate:this.edit_user_param.err=!0;break}if("data"==s.ErrMessageType.toString()){let e=this.findRoom(s.UserId);if(e.messages.length<s.IndexNumber)return;e.messages[s.IndexNumber-1].err=!0}},connectUser(e){this.selected_room.id==e&&(this.selected_room.online=!0);for(let s=0;s<this.list.length;s++)if(this.list[s].id==e)return void(this.list[s].online=!0)},disconnectUser(e){this.selected_room.id==e&&(this.selected_room.online=!1);for(let s=0;s<this.list.length;s++)if(this.list[s].id==e)return void(this.list[s].online=!1)},registrationNewUser(e,s){this.list.push({id:e,name:s,online:!1,isActiveMessage:!1,numOfMessages:0});let t=this.findRoom(0);t.messages.push({from:"other",name:s,type:"text",message:"Зарегестрирован новый пользователь",err:!1})},userUpdate(e,s){let t=this.findUser(e),a=t.name,i=this.findRoom(0);i.messages.push({from:"other",name:a,type:"text",message:"Пользователь сменил имя на "+s,err:!1}),t.name=s},processingUsersList(e){let s=!1;"set list"!=e.UsersList.ListCommand&&"refresh list"!=e.ListCommand||(this.list.length=0,this.rooms.length=1);for(let t of e.UsersList.ListElements)s=0!=t[1].nrm,this.list.push({id:t[0],name:t[1].name,online:t[1].online,isActiveMessage:s,numOfMessages:t[1].nrm}),this.rooms.push({id:t[0],lastLoadedNumber:0,messages:[]})},fillUserInfo(){this.user_info.name=this.control.UserInfo.Name,this.user_info.surname=this.control.UserInfo.Surname,this.user_info.familyname=this.control.UserInfo.Familyname,this.user_info.birthday=this.control.UserInfo.Birthdate},fillMessageList(e){if(0==e)return;let s=this.findRoom(this.selected_room.id);for(let t=0;t<e;t++)s.messages.push({from:"me",name:"",type:"text",message:"",err:!1});this.selected_room.lastLoadedNumber=e,this.$nextTick((()=>this.observeMessages()))},findRoom(e){for(let s=0;s<this.rooms.length;s++)if(this.rooms[s].id==e)return this.rooms[s]},findUser(e){for(let s=0;s<this.list.length;s++)if(this.list[s].id==e)return this.list[s]},nameFromId(e){for(let s=0;s<this.list.length;s++)if(this.list[s].id==e)return this.list[s].name},setActiveMessageInRoom(e){for(let s=0;s<this.roomsList.length;s++)if(this.roomsList[s].id==e)return this.roomsList[s].isActiveMessage=!0,void this.roomsList[s].numOfMessages++},setActiveMessageInList(e){for(let s=0;s<this.list.length;s++)if(this.list[s].id==e)return this.list[s].isActiveMessage=!0,void this.list[s].numOfMessages++},logout(){let e={id:this.id};(0,Me.bE)("/logout",e).then((()=>{localStorage.removeItem("name"),this.websocket.close(1e3,"работа закончена"),this.$router.push("/login")})).catch((e=>{console.log(e)}))},setUserName(){return this.user_name},showEditUser(){this.isShowEditUser=!0},showEmoji(){this.isEmoji=!0},closeEmoji(e){(void 0==e||e.offsetY>0)&&(this.isEmoji=!1)},askUserInfo(){if(this.control.clear(),this.control.ControlMessageType.value=He.T.ControlMessage.UserInfoRequest,null==this.websocket)return this.edit_user_param.err=!0,void(this.edit_user_param.errString="Сервер не доступен");this.websocket.send(this.control.code())},updateUser(){if(this.control.clear(),this.control.ControlMessageType.value=He.T.ControlMessage.UserInfoUpdate,this.control.UserInfo.Name=this.user_info.name,this.control.UserInfo.Surname=this.user_info.surname,this.control.UserInfo.Familyname=this.user_info.familyname,this.control.UserInfo.Birthdate=this.user_info.birthday,null==this.websocket)return this.edit_user_param.err=!0,void(this.edit_user_param.errString="нет связи с сервером");this.websocket.send(this.control.code())},closeEditUser(){this.edit_user_param.err=!1,this.edit_user_param.ok=!1,this.edit_user_param.errString="",this.isShowEditUser=!1},showChangePass(){this.isShowChangePass=!0,this.isShowEditUser=!1},closeChangePass(){this.isShowChangePass=!1,this.isShowEditUser=!0},userListClick(e){if(null==this.websocket)return;this.isRoom=!1,1==e.isActiveMessage&&(e.isActiveMessage=!1,this.setReaded(e.id)),e.numOfActiveMessages=0,this.selected_room.id=e.id,this.selected_room.name=e.name,this.selected_room.online=e.online;let s=this.findRoom(this.selected_room.id);null!=s&&(this.selected_room.lastLoadedNumber=s.lastLoadedNumber,0==s.lastLoadedNumber?this.askMessagesFromSErver():this.$nextTick((()=>{const e=document.getElementById("messages");e.scrollTo({top:e.scrollHeight}),0!=s.messages.length&&1!=s.lastLoadedNumber&&this.observeMessages()})))},askMessagesFromSErver(){null!=this.websocket&&(this.control.clear(),this.control.ControlMessageType.value=He.T.ControlMessage.MessagesRequest,this.control.MessagesRequest.RoomId=this.selected_room.id,this.control.MessagesRequest.LastMessageNumber=this.selected_room.lastLoadedNumber,this.websocket.send(this.control.code()))},observeMessages(){this.observerOptions.root=document.getElementById("messages");const e=new IntersectionObserver(this.loadMessages,this.observerOptions),s=document.querySelectorAll(".message");0!=s.length&&s.forEach((s=>{e.observe(s)}))},messageSpaceClick(){if(this.isRoom){for(let e=0;e<this.roomsList.length;e++)if(this.roomsList[e].id==this.selected_room.id)return this.roomsList[e].isActiveMessage=!1,void(this.roomsList[e].numOfMessages=0)}else for(let e=0;e<this.list.length;e++)if(this.list[e].id==this.selected_room.id)return 1==this.list[e].isActiveMessage&&(this.list[e].isActiveMessage=!1,this.setReaded(this.selected_room.id)),void(this.list[e].numOfMessages=0)},roomClick(e){this.isRoom=!0,e.isActiveMessage=!1,e.numOfActiveMessages=0,this.selected_room.id=e.id,this.selected_room.name=e.name},roomSelected(e){return e==this.selected_room.id},setReaded(e){let s=He.T.Acknowledge;s.clear(),s.AckMessageType.value=2,s.DataAckType.value=3,s.UserId=e,this.websocket.send(s.code())},compressImage(e){let s=document.createElement("canvas"),t=new Image;t.src=e;let a=t.width,i=t.height;const o=200,r=200;a>i?a>o&&(i=Math.round(i*=o/a),a=o):i>r&&(a=Math.round(a*=r/i),i=r),s.width=a,s.height=i;let n=s.getContext("2d");return n.drawImage(t,0,0,a,i),s.toDataURL("image/jpeg",.7)},loadImage(e){let s=e.target;if(s.files&&s.files[0]){let e=new FileReader,t=this;e.onload=function(e){t.imageSrc=e.target.result,t.isImage=!0},e.readAsDataURL(s.files[0])}},popUpImage(e){this.isShowImagePreview=!0,this.popUpImgSrc=e},closePopUpImage(){this.isShowImagePreview=!1,this.popUpImgSrc=""},closePreview(){this.$refs.imgUpload.value=null,this.imageSrc="",this.isImage=!1},showSendBtn(){return""!=this.text||""!=this.imageSrc},set_emoji(e){document.getElementById("add_text").value+=e.value,this.text+=e.value},loadMessages(e){let s=0;e.forEach((e=>{s++,e.intersectionRatio>0&&s<this.selected_room.lastLoadedNumber&&this.askMessagesFromSErver()}))}},computed:{filteredList(){let e=this.filter_name;return this.list.filter((s=>s.name.toLowerCase().includes(e.toLowerCase())))},indexOfSelectedRoom(){for(let e=0;e<this.rooms.length;e++)if(this.rooms[e].id==this.selected_room.id)return e;return-1}},updated(){}};const Je=(0,ie.A)(Ge,[["render",j],["__scopeId","data-v-4a43c16e"]]);var Ye=Je}}]);
//# sourceMappingURL=931.f6cfb643.js.map